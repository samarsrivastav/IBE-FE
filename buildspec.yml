version: 0.2

env:
  shell: bash
  variables:
    # Define environment mappings here for easier maintenance
    DEV_BRANCH: "dev"
    QA_BRANCH: "qa"

phases:
  install:
    commands:
      - npm ci

  pre_build:
    commands:
      - echo "Extracting branch name..."
      - BRANCH_NAME=$(echo "$CODEBUILD_SOURCE_VERSION" | sed 's|refs/heads/||')
      - echo "Branch detected: $BRANCH_NAME"
      - |
        case "$BRANCH_NAME" in
          "$DEV_BRANCH") echo "BUILD_ENV=dev" > build_env.sh ;;
          "$QA_BRANCH") echo "BUILD_ENV=qa" > build_env.sh ;;
          *)
            echo "Unsupported branch: $BRANCH_NAME"
            echo "Only $DEV_BRANCH and $QA_BRANCH branches are supported"
            exit 1
            ;;
        esac
      - source build_env.sh
      - echo "BUILD_ENV is set to $BUILD_ENV"

  build:
    commands:
      - echo "Running build for environment: $BUILD_ENV"
      - npm run build:$BUILD_ENV

artifacts:
  files:
    - "**/*"
  base-directory: dist/